<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>HTML5 video description test</title>
	<meta name="title" content="HTML5 video description test">
	<meta name="description" content="Test use of the HTML5 video tag for DVX description of video">
	<meta name="keywords" content="HTML5, video description, extended description, media, accessibility">
	<style>
	</style>
	<!-- <script src="http://code.jquery.com/jquery-git.js"></script>
	<script src="https://getfirebug.com/firebug-lite-debug.js"></script> -->
	<script src="mediagroup.js/src/mediagroup.js"></script>
	<script type="text/javascript">
		// This structure should clearly be an XML file!!
		// Structure is:
		//     StartVideoTimecode (seconds)
		//     Duration (seconds)
		//     inline|extended
		var descriptionList = [ [1.0, 7.0, "inline", "EDclip001.ogg"], [11.0, 5.0, "inline", "EDclip002.ogg"], [16.0, 5.0, "inline", "EDclip003.ogg"], [28.0, 10.0, "extended", "EDclip004.ogg"] ];
		var audioOffsetList = [0];
		var currentPlayedDescription = 0;
		var inInlineDescription = false;
		var inExtendedDescription = false;
		var lastDescriptionVideoTime = -1;
		var lastDescriptionAudioTime = -1;
		var lastDescriptionCurrent = 0;
		
		function myPlayPause() {
			var mediaController = document.querySelectorAll('video')[0].controller;
			var myAudio = document.getElementsByTagName('audio')[0];

			if (mediaController.paused) {
				mediaController.play();
				if ( inInlineDescription ) myAudio.play();
				else myAudio.pause();
			} else {
				mediaController.pause();
				if ( inInlineDescription ) myAudio.pause();
			}
		}
		var prevCurrentTime = 0;
		function showTimecode() {
			var myVideo = document.getElementsByTagName('video')[0];
			//var endBuf = myVideo.buffered.end(0);
			//var soFar = parseInt(((endBuf / myVideo.duration) * 100));
			var myCurrentTime = myVideo.currentTime;
			document.getElementById("loadStatus").innerHTML =  parseInt(myCurrentTime * 100)/100 + ' secs, delta = ' + parseInt((myCurrentTime - prevCurrentTime) * 100)/100 + ' secs';
			prevCurrentTime = myCurrentTime;
		}
		function myFixAutoPlay(){
			// Fix autoplay:
			// In order for the separate audio/video tracks to work correctly with the mediaController,
			//  we have to set them with 'autoplay' otherwise they won't play. But, if we don't want the
			//  mediaController to autoplay, we need to pause it here.

			var mediaController = document.querySelectorAll('video')[0].controller;
			//mediaController.pause();
		}
		function myAddListeners(){
			var mediaController = document.querySelectorAll('video')[0].controller;
			mediaController.addEventListener('timeupdate', controlInlineDescription, false);
			mediaController.addEventListener('canplay', myFixAutoPlay, false);

			//var myVideo = document.getElementsByTagName('video')[0];
			//myVideo.addEventListener('timeupdate', controlInlineDescription, false);

			var myAudio = document.getElementsByTagName('audio')[0];
			myAudio.addEventListener('timeupdate', controlExtendedDescription, false);
			myAudio.addEventListener('ended', DescriptionClipEnded, false);
			
			mediaController.addEventListener('pause', pauseInlineDescription, false);
			mediaController.addEventListener('play', playInlineDescription, false);
			
			currentPlayedDescription = 0;
			inInlineDescription = false;
			inExtendedDescription = false;

			var audioOffset = 0;
			for(i=0; i<descriptionList.length; i++ ) {
				audioOffsetList[i] = audioOffset;
				audioOffset = audioOffset + descriptionList[i][1];
			}
		}
		function pauseInlineDescription(){
			var myAudio = document.getElementsByTagName('audio')[0];
			if ( !myAudio.paused ) myAudio.pause();
		}
		function playInlineDescription(){
			var myAudio = document.getElementsByTagName('audio')[0];
			if ( myAudio.paused ) myAudio.play();
		}
		function controlInlineDescription(){
			showTimecode();

			var mediaController = document.querySelectorAll('video')[0].controller;
			var myVideo = document.getElementsByTagName('video')[0];
			var myAudio = document.getElementsByTagName('audio')[0];

			if ( !inInlineDescription ) {
				if ( ( mediaController.currentTime >= descriptionList[currentPlayedDescription][0] ) && ( mediaController.currentTime < ( descriptionList[currentPlayedDescription][0] + descriptionList[currentPlayedDescription][1] ) ) && ( "inline" == descriptionList[currentPlayedDescription][2] ) ) {
					myAudio.currentTime = 0;
					lastDescriptionVideoTime = mediaController.currentTime;
					lastDescriptionAudioTime = myAudio.currentTime;
					lastDescriptionCurrent = currentPlayedDescription;

					if ( myAudio.paused ) myAudio.play();
					inInlineDescription = true;

					document.getElementById("repeatLast").disabled = false;

					document.getElementById("DescriptionDebug").innerHTML = "Playing " + descriptionList[currentPlayedDescription][2] + " description " + currentPlayedDescription;
				}
				
				if ( ( mediaController.currentTime >= descriptionList[currentPlayedDescription][0] ) && ( mediaController.currentTime < ( descriptionList[currentPlayedDescription][0] + descriptionList[currentPlayedDescription][1] ) ) && ( "extended" == descriptionList[currentPlayedDescription][2] ) ) {
					myAudio.currentTime = 0;
					lastDescriptionVideoTime = mediaController.currentTime;
					lastDescriptionAudioTime = myAudio.currentTime;
					lastDescriptionCurrent = currentPlayedDescription;

					if ( !myVideo.paused ) myVideo.pause();
					if ( myAudio.paused ) myAudio.play();
					inExtendedDescription = true;

					document.getElementById("repeatLast").disabled = false;

					document.getElementById("DescriptionDebug").innerHTML = "Playing " + descriptionList[currentPlayedDescription][2] + " description " + currentPlayedDescription;
				}

			}
		}
		function DescriptionClipEnded() {
			var mediaController = document.querySelectorAll('video')[0].controller;
			var myVideo = document.getElementsByTagName('video')[0];
			var myAudio = document.getElementsByTagName('audio')[0];

			if ( inInlineDescription ) {
				inInlineDescription = false;
				currentPlayedDescription = currentPlayedDescription + 1;
			}
			if ( inExtendedDescription ) {
				if ( myVideo.paused ) myVideo.play();
				inExtendedDescription = false;
			}
			
			if ( currentPlayedDescription >= descriptionList.length ) {
				currentPlayedDescription = currentPlayedDescription - 1;
			}
			document.getElementById("DescriptionDebug").innerHTML = "Waiting for " + descriptionList[currentPlayedDescription][2] + " description " + currentPlayedDescription;

			myAudio.src = descriptionList[currentPlayedDescription][3];
			myAudio.load();
			myAudio.pause();
		
			document.getElementById("DescriptionAudioDebug").innerHTML = "Loading audio clip " + descriptionList[currentPlayedDescription][3];
		}
		function controlExtendedDescription(){
			var mediaController = document.querySelectorAll('video')[0].controller;
			var myVideo = document.getElementsByTagName('video')[0];
			var myAudio = document.getElementsByTagName('audio')[0];

		}
		function repeatLastDescription() {
			var mediaController = document.querySelectorAll('video')[0].controller;
			var myAudio = document.getElementsByTagName('audio')[0];

			if ( ( lastDescriptionVideoTime >= 0 ) && ( lastDescriptionAudioTime >= 0 ) ) {
				mediaController.currentTime = lastDescriptionVideoTime;
				myAudio.currentTime = lastDescriptionAudioTime;
				if ( !inInlineDescription ) {
					if ( myAudio.paused ) myAudio.play();
					inInlineDescription = true;
					currentPlayedDescription = lastDescriptionCurrent;
					document.getElementById("DescriptionDebug").innerHTML = descriptionList[currentPlayedDescription][2] + " description " + currentPlayedDescription;
				}
			}
		}
</script>
</head>

<body onload="myAddListeners()">

	<video class="controller" controls autoplay mediagroup="described_video">
		<source src="http://archive.org/download/ElephantsDream/ed_1024_512kb.mp4"></source>
		<source src="http://archive.org/download/ElephantsDream/ed_1024.ogv"></source>
		<source src="http://archive.org/download/ElephantsDream/ed_1024.avi"></source>
	</video>

<!-- This audio is controlled by the same mediaController as the video, 
     so it always plays in sync with the video. It is suitable for a
	 monolithic, inline description track.
-->
<!--
	<audio autoplay mediagroup="described_video">
		<source src="411.mp3"></source>
		<source src="411.ogg"></source>
	</audio>
-->

<!-- This audio is NOT controlled by the same mediaController as the video.
     It is more suitable for an extended description track.
-->
	<audio>
		<source src="EDclip001.ogg"></source>
	</audio>

	<div class="video-player-controls">
		<p id="loadStatus">MOVIE LOADING...</p>
		<p id="DescriptionDebug">DescriptionDebug</p>
		<p id="DescriptionAudioDebug">DescriptionAudioDebug</p>
		<!-- Note: this button is accessible using "Alt-p" -->
		<input type="button" onclick="myPlayPause()" accesskey="p" value="Play/Pause">
		<input type="button" onclick="repeatLastDescription()" accesskey="r" value="Skip to Recent Description" disabled id="repeatLast">
	</div>

</body>

</html>
